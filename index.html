<!DOCTYPE html>
<html lang="en">
<head>
	<title>Aging in Context</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="static/leaflet/leaflet.css">
    <link rel="stylesheet" type="text/css" href="static/css/L.Control.Sidebar.css">
    <script src="static/leaflet/leaflet.js" type="text/javascript"></script>
    <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
    <script src="static/js/Leaflet.MakiMarkers.js"></script>
    <script src="static/js/L.Control.Sidebar.js"></script>
    <style type="text/css">
    #map {
        height: 80vh;
    }

    #patient-head{
        padding: 1em;
        border-radius: 5px;
        background-color: rgba(255, 255, 255, 0.75);
    }

    .navbar-container{
        background-color: rgb(66, 139, 202);
        border-radius: 0;
        border: none;
    }
    </style>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">

    <!-- Optional theme -->
    

    <!-- Latest compiled and minified JavaScript -->
    <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
</head>

<body>
    <nav class="navbar navbar-inverse" role="navigation" style="border:none;">
      <div class="container-fluid navbar-container">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
            <a class="navbar-brand" href="#" style="color:white;">URMC Geographic Data Infrastructure</a>
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <form class="navbar-form navbar-right" role="search">
            <div class="form-group">
                <input class="form-control" placeholder="Patient ID">
                <button type="submit" class="btn btn-default">Search</button>
            </div>
        </form>
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container-fluid -->
    </nav>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-8">
                <div id="map">
                </div>
            </div>
            <div class="col-md-4">
                <ul class="nav nav-tabs" role="tablist">
                  <li class="active"><a href="#home" role="tab" data-toggle="tab">Patient</a></li>
                  <li><a href="#neighborhood" role="tab" data-toggle="tab">Neighborhood</a></li>
                  <li><a href="#caretaker" role="tab" data-toggle="tab">Caretaker</a></li>
                  <li><a href="#notes" role="tab" data-toggle="tab">Notes</a></li>
                </ul>
                <!-- Tab panes -->
                <div class="tab-content">
                  <div class="tab-pane active" id="home">
                      <div id="patient_sidebar">
                        <br>
                           <div class="panel panel-default">
                                <div class="panel-heading">Basic Information</div>
                                <table id="patient-information" class="table">
                                <tbody>
                                    <tr class="name-marital"><td colspan="2" class="name"></td><td colspan="1" class="marital"></td></tr>
                                    <tr class="basic-info"><td class="age"></td><td class="dob"></td><td class="gender"></td></tr>
                                    <tr class="insurance"><td colspan="3"></td></tr>
                                    <tr class="car-access"><td colspan="3"></td></tr>
                                </tbody>
                                </table>
                            </div>
                            <div class="panel panel-default">
                                <div class="panel-heading">Health behaviors</div>
                                <table id="health-behaviors" class="table">
                                <tbody>
                                    <tr class="smoking"><td></td></tr>
                                    <tr class="alcohol"><td></td></tr>
                                    <tr class="drugs"><td></td></tr>
                                </tbody>
                                </table>
                            </div>
                            <div class="panel-group" id="accordion">
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseOne">Major diagnosis</a>
                                    </div>
                                    <div id="collapseOne" class="panel-collapse collapse">
                                        <table id="major-diagnosis" class="table">
                                        <tbody>
                                            
                                        </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                        <a data-toggle="collapse" data-parent="#accordion" href="#collapseTwo">Recent clinical interaction</a>
                                    </div>
                                    <div id="collapseTwo" class="panel-collapse collapse">
                                        <table id="recent-diagnosis" class = "table">
                                        <tbody>
                                            
                                        </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                  </div>
                  <div class="tab-pane" id="neighborhood">
                        <table class="table">
                            <tbody id="indicators" >
                            </tbody>
                            <tfoot id="indicator-source">
                                <tr><td colspan=2>
                                    Source: ACS 5-year estimates, 2012, zip code level
                                </td></tr>
                            </tfoot>
                        </table>
                  </div>
                  <div class="tab-pane" id="caretaker">
                            <table id="caretaker-information" class="table">
                            <tbody>
                                <tr><td id="cg-name-address"></td></tr>
                                <tr><td colspan=2 id="cg-distance"></td></tr>
                                <tr><td colspan=2 id="cg-relation"></td></tr>
                                <tr><td colspan=2 id="cg-vehicle"></td></tr>
                            </tbody>
                            </table>
                  </div>
                  <div class="tab-pane" id="notes">...</div>
                </div>

            <!--  -->
            </div>
        </div>
        <div class="row">
        </div>
    </div>
 <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script>
<script>
    //map environmental variables
    var map;
    var zoom_max = 14;
    var init_bounds = L.latLngBounds(
        L.latLng(40.59875083395948, -79.23850049516057), 
        L.latLng(44.75896447862758, -73.27685372593069));

    var icd_definitions = {
        "J32.9": "Chronic sinusitis, unspecified",
        "M75.41": "Impingement syndrome of right shoulder",
        "E11.9": "Type 2 diabetes mellitus without complications",
        "M17.9": "Osteoarthritis of knee, unspecified",
        "Z22.4": "Carrier of infections with a predominantly sexual mode of transmission",
        "F03.90": "Unspecified dementia without behavioral disturbance",
        "J01.0": "Acute maxillary sinusitis",
        "S46.111A": "Strain of muscle, fascia and tendon of long head of biceps, right arm",
        "Z72.0": "Tobacco use",
        "I25.5": "Ischemic cardiomyopathy",
        "I25.10": "Atherosclerotic heart disease of native coronary artery without angina pectoris",
        "N85.01": "Benign endometrial hyperplasia"
    }

    var patient_marker = false;
    var patient_head = L.control({position: 'topright'});
    patient_head.added = false;
    window.onload = function(){
        map = L.map('map');
        L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
        }).addTo(map);
        map.fitBounds(init_bounds);
        $('.panel-group').collapse();

        //get data and definitions
        var definitions, zipData;
        //get definitions
        $.ajax({
            url: 'static/json/definitions.json',
            type: "get",
            dataType: "json",
            async: false,
            success: function(data){definitions = data}
        });
        //get data
        $.ajax({
            url: 'static/json/zc_data.json',
            type: "get",
            dataType: "json",
            async: false,
            success: function(data){zipData = data}
        });
        
        
        function addCommas(nStr) {
            nStr += '';
            var x = nStr.split('.');
            var x1 = x[0];
            var x2 = x.length > 1 ? '.' + x[1] : '';
            var rgx = /(\d+)(\d{3})/;
            while (rgx.test(x1)) {
                x1 = x1.replace(rgx, '$1' + ',' + '$2');
            }
            return x1 + x2;
        }
        //defining objects
        //patient object definition
        function Patients(file){
            var self = this;
            $.ajax({
                url:file,
                type: "get",
                dataType:"json",
                async: false,
                success: function(data){self.data = data}
            });
        };

        Patients.prototype.isLoaded = function(){
            if(this.data)
                return true;
            return false;
        };

        Patients.prototype.getPatientByID = function(id) {
            var patient = this.data.features.filter(function(person){
                return person.properties.ID == id;
            }, this);
            return patient[0];
        }

        //selected patient object definition
        function PatientView(id, patients) {
            this.patient = patients.getPatientByID(id);
            this.latlng = L.latLng(
                this.patient.geometry.coordinates[1],
                this.patient.geometry.coordinates[0]
                );
            this.Name = this.getPropertyByName("FirstName") + " " + this.getPropertyByName("LastName");
            
            this.RD_ICD = [];
            for (prop in this.patient.properties) {
                if(prop.search(/R\d_ICD/) != -1) this.RD_ICD.push(this.getPropertyByName(prop));
                else 
                    Object.defineProperty(this,prop,{
                    value:this.getPropertyByName(prop),
                    writable: false});
            }
        }
        PatientView.prototype.getPropertyByName = function(property){
            return this.patient.properties[property];
        }

        //testing backbone.js routing
        var Router = Backbone.Router.extend({
            routes: {
                'patient/:patient': 'patient'
            }
        });
        var router = new Router();
        router.on('route:patient', loadPatient);
        Backbone.history.start();

        //implementation
        function loadPatient(patientID){
            var file = "static/json/fake_patients.geojson"
            patient = new PatientView(patientID, new Patients(file));
            if(patient_marker) 
                map.removeLayer(patient_marker);
            patient_marker = L.marker(patient.latlng);
            patient_marker.addTo(map);
            patient_marker.bindPopup(patient.Name);
            map.setView(patient_marker.getLatLng(), zoom_max);
            //filter zip data
            patientZipData = zipData.filter(function(row){
                return row.ZCTA.toString() == patient.ZIP;
            })[0];
            
            //implement patient ui elements
            if(patient_head.added) map.removeControl(patient_head);
            patient_head.onAdd = function(map){
                this.added = true;
                var $head = $('<div id="patient-head">');
                $head.html('<h4>'+patient.Name+'</h4><address>'+patient.Address+'<br>'+patient.City+', NY '+patient.ZIP+'</address>');
                return $head[0];
            }
            map.addControl(patient_head);

            $('.name').text('Name: '+patient.Name);
            $('.marital').text(patient.MaritalStatus);
            $('.age').text('Age: '+patient.Age);
            $('.dob').text('DOB: '+patient.DOB);
            $('.gender').text('Gender: '+patient.Gender)
            $('.insurance>td').text('Insurance: '+patient.Insurance);
            $('.car-access>td').text('Access to car: '+patient.Vehicle);
            $('.smoking>td').text('Smoking: '+patient.Smoking);
            $('.alcohol>td').text('Alcohol: '+patient.AlcUse);
            $('.drugs>td').text('Illicit drug use: '+patient.IllDrugUse);
            $('#patient-head').find(".address").bind("click", function(){
                map.setView(patient.latlng);
            }).css("cursor", "pointer");
            $('#major-diagnosis>tbody').empty();
            $('#recent-diagnosis>tbody').empty();
            $('#major-diagnosis>tbody').append($('<tr>').append($('<td>').text(patient.MD_ICD))
                .append($('<td>').text(icd_definitions[patient.MD_ICD])));
            patient.RD_ICD.forEach(function(rd){
                console.log(icd_definitions[rd]);
                if(rd) 
                    $('#recent-diagnosis>tbody').append($('<tr>').append($('<td>').text(rd))
                        .append($('<td>').text(icd_definitions[rd])));
            })
            //add neighborhood indicators
            $('#indicators').empty();
            definitions.forEach(function(d){
                $('#indicators').append($('<tr>').append($('<td>').html('<strong>'+d.Label+'</strong>')).append($('<td align=right>').html(patientZipData[d.VariableName]+' (&#xb1;'+patientZipData[d.MoE]+')')));
            });

            //add caretaker information
            $('#cg-name-address').html('<strong>'+patient.CG_Name+'</strong><br>'+patient.CG_Add+'<br>'+patient.CG_City+', '+patient.CG_State);
            $('#cg-relation').html('<strong>Relationship: </strong>'+patient.CG_Relationship);
            $('#cg-address').html('<strong>Address:</strong> '+patient.CG_Add+'<br>'+patient.CG_City+', '+patient.CG_State);
            $('#cg-vehicle').html('<strong>Vehicle:</strong> '+patient.CG_Vehicle);
            $('#cg-distance').html('<strong>Distance to patient:</strong> '+patient.CG_Distance+' miles');
        }
        loadPatient("URMC1");
    }
</script>
</body>
</html>
